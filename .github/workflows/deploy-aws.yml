name: Deploy KSdb Cloud to AWS

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ksdb-cloud
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -f Dockerfile.cloud -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
      
      - name: Deploy to AWS App Runner
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ksdb-cloud
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
          ROLE_ARN: "arn:aws:iam::701544683046:role/service-role/AppRunnerECRAccessRole"
        run: |
          # Check if service exists
          SERVICE_ARN=$(aws apprunner list-services --region ap-south-1 --query "ServiceSummaryList[?ServiceName=='ksdb-cloud-service'].ServiceArn" --output text)
          
          if [ -z "$SERVICE_ARN" ]; then
            echo "Creating new App Runner service..."
            aws apprunner create-service \
              --service-name ksdb-cloud-service \
              --region ap-south-1 \
              --source-configuration "{
                \"AuthenticationConfiguration\": {
                  \"AccessRoleArn\": \"$ROLE_ARN\"
                },
                \"ImageRepository\": {
                  \"ImageIdentifier\": \"$ECR_REGISTRY/$ECR_REPOSITORY:latest\",
                  \"ImageRepositoryType\": \"ECR\",
                  \"ImageConfiguration\": {
                    \"Port\": \"8000\",
                    \"RuntimeEnvironmentVariables\": {
                      \"DATABASE_URL\": \"$DATABASE_URL\",
                      \"ADMIN_KEY\": \"$ADMIN_KEY\"
                    }
                  }
                },
                \"AutoDeploymentsEnabled\": true
              }" \
              --instance-configuration "{
                \"Cpu\": \"1 vCPU\",
                \"Memory\": \"2 GB\"
              }" \
              --health-check-configuration "{
                \"Protocol\": \"HTTP\",
                \"Path\": \"/health\",
                \"Interval\": 10,
                \"Timeout\": 5,
                \"HealthyThreshold\": 1,
                \"UnhealthyThreshold\": 5
              }"
          else
            echo "Updating existing App Runner service..."
            aws apprunner update-service \
              --service-arn $SERVICE_ARN \
              --region ap-south-1 \
              --source-configuration "{
                \"AuthenticationConfiguration\": {
                  \"AccessRoleArn\": \"$ROLE_ARN\"
                },
                \"ImageRepository\": {
                  \"ImageIdentifier\": \"$ECR_REGISTRY/$ECR_REPOSITORY:latest\",
                  \"ImageRepositoryType\": \"ECR\"
                }
              }"
          fi
          
          # Wait for service
          aws apprunner wait service-ready --service-arn $SERVICE_ARN --region ap-south-1
          
          # Get URL
          SERVICE_URL=$(aws apprunner describe-service --service-arn $SERVICE_ARN --region ap-south-1 --query "Service.ServiceUrl" --output text)
          
          echo "ðŸŽ‰ Deployment complete!"
          echo "Service URL: https://$SERVICE_URL"
          echo "API Docs: https://$SERVICE_URL/docs"
